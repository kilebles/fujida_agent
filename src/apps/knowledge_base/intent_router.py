from common.openai_client import ensure_openai_client


class IntentRouter:
    async def classify(self, user_message: str) -> str:
        """
        Возвращает intent: 'FAQ', 'Device', 'Other'
        """
        prompt = f"""
            Ты классифицируешь вопросы пользователей о продукции Fujida.

            Категории:
            - FAQ → вопросы о поддержке, неисправностях, обновлениях, прошивках, гарантиях, ремонте, сервисе, связи с техподдержкой.
            - Device → вопросы о моделях, их характеристиках, различиях, сравнении, поиске или подборе устройства.
            - Other → всё, что не связано с продуктами Fujida.

            Устройства могут упоминаться по-разному: "про макс", "дуос", "око", "окко", "блисс", "хара", "слим", "хит", "магна", "эра", и другие. 
            У тебя есть список моделей и их алиасов (названий). Если в тексте встречается одно из них — это значит, что речь идёт о продукции Fujida.

            Правило приоритета:
            1. Если вопрос про неисправность, гарантию, ремонт, обновления или поддержку → всегда FAQ, даже если указана модель.
            2. Если вопрос про характеристики, отличия или выбор устройства → Device.
            3. Если вопрос не относится к Fujida → Other.

            Примеры:
            - "Модель Zoom Okko, на экране отображаются знаки ограничения скорости" → FAQ
            - "Как обновить прошивку на Pro Max?" → FAQ
            - "Какая модель лучше, Pro Max или Pro S?" → Device
            - "Подскажите характеристики Karma One" → Device
            - "Где можно купить зарядку для телефона?" → Other

            Вопрос: "{user_message}"
            Ответ: только одно слово: FAQ, Device или Other.
            """
        client = await ensure_openai_client()
        resp = await client.responses.create(
            model="gpt-4.1-mini",
            input=[{"role": "user", "content": prompt}],
        )
        return resp.output_text.strip()