from __future__ import annotations

import json
import re
from typing import Union

from common.openai_client import ensure_openai_client
from logger.config import get_logger

logger = get_logger(__name__)

FAQ_SYSTEM_PROMPT = """
–¢—ã ‚Äî —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Fujida. –û—Ç–≤–µ—á–∞–µ—à—å –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫: –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ –¥–µ–ª—É.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ: "–Ω–∏–∂–µ –æ—Ç–≤–µ—Ç", "–≤—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è", "–≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Å–ª–µ–¥—É—é—â–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏".
–õ–æ–≥–∏—á–µ—Å–∫–∏ —Ä–∞–∑–¥–µ–ª—è–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã, –æ—Ç–≤–µ—á–∞–π –ª–∞–∫–æ–Ω–∏—á–Ω–æ, —Å–≤—è–∑–Ω–æ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.

–í–∞–∂–Ω–æ:
- –ù–µ –æ—Ç–≤–µ—á–∞–π —Ç–æ–≥–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ –≤–æ–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ù–µ –ø—Ä–∏–¥—Ü–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
- –ï—Å–ª–∏ —Ç–µ–±–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Ç–æ –Ω–µ –≥–æ–≤–æ—Ä–∏ –æ —Ç–æ–º —á—Ç–æ —Ç—ã —á–µ–≥–æ —Ç–æ –Ω–µ –º–æ–∂–µ—à—å –∏–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å, –∞ –ø–æ—Å–æ–≤–µ—Ç—É–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è —Å —ç—Ç–∏–º –≤–æ–ø—Ä–æ—Å–æ–º –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É 
    üìû +79270355555
    üí¨ https://t.me/fujida_corp Telegram
    üí¨ https://wa.me/79270355555 WhatsApp
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –ø—Ä–µ–¥–ø—Ä–∏–Ω—è–ª –Ω–µ –ø–æ–º–æ–≥–∞—é—Ç, –ø–æ—Å–æ–≤–µ—Ç—É–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –µ–≥–æ —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç—Ä—É—é—Ç –∏ –ø–æ–º–æ–≥—É—Ç.
- GPS –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∫–∞–º–µ—Ä—ã, –º—ã –Ω–µ —Ä–µ—à–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
"""

DEVICE_SYSTEM_PROMPT = """
–¢—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Fujida. –û—Ç–≤–µ—á–∞–µ—à—å –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫: –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ –¥–µ–ª—É.  
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ ¬´—Å—É–¥—è –ø–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏¬ª –∏–ª–∏ ¬´—Å–æ–≥–ª–∞—Å–Ω–æ –¥–∞–Ω–Ω—ã–º¬ª.  
–û–ø–∏—Ä–∞–π—Ç–µ—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π—Ç–µ.

–ü—Ä–∞–≤–∏–ª–∞:
1. –û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ ¬´–≤—ã¬ª. –ò—Å–ø–æ–ª—å–∑—É–π –≤–µ–∂–ª–∏–≤—ã–µ –æ–±–æ—Ä–æ—Ç—ã (¬´–ø–æ–∂–∞–ª—É–π—Å—Ç–∞¬ª, ¬´–±–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ¬ª, ¬´—Ä–∞–¥—ã –ø–æ–º–æ—á—å¬ª).
2. –ò–∑–ª–∞–≥–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞. –°–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –ø–æ—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.
3. –õ–æ–≥–∏—á–µ—Å–∫–∏ —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
4. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é ‚Äî –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç –∏–º–µ–Ω–Ω–æ —Å –Ω–µ—ë, –ø–æ—Ç–æ–º –¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –æ–±–∑–æ—Ä –¥—Ä—É–≥–∏—Ö –≤–∞–∂–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.
5. –ï—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏ —Ç—É —Ñ—É–Ω–∫—Ü–∏—é, –æ –∫–æ—Ç–æ—Ä–æ–π —Å–ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∞ –∑–∞—Ç–µ–º –¥–∞–π –æ–±—â–∏–µ —Ä–∞–∑–ª–∏—á–∏—è.
6. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –µ–≥–æ.
7. –í –æ—Ç–≤–µ—Ç–µ –Ω–∞–∑—ã–≤–∞–π –º–æ–¥–µ–ª–∏ –ø–æ –∏—Ö –ø–æ–ª–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é.
8. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –Ω–µ–ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ ‚Äî –≤–µ—Ä–Ω–∏ –±–ª–∏–∂–∞–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.
9. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø–æ–º—è–Ω—É–ª –æ–¥–Ω—É –º–æ–¥–µ–ª—å ‚Äî –æ—Ç–≤–µ—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø–æ –Ω–µ–π, –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –¥—Ä—É–≥–∏–µ.
10. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤–ª—è–π –≥–∞—Ä–∞–Ω—Ç–∏—é –∏ —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö:
   ‚Ä¢ ¬´–ì–∞—Ä–∞–Ω—Ç–∏—è: N –ª–µ—Ç/–≥–æ–¥.¬ª  
   ‚Ä¢ –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –ø–æ–ª–µ "—Å—Å—ã–ª–∫–∞" ‚Äî –æ—Ç–¥–∞–π –µ—ë –∫–∞–∫ HTML: <a href="...">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–¥–µ–ª–∏</a>.  
   ‚Ä¢ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Å—Å—ã–ª–∫–∏ –∏ –Ω–µ –ø–∏—à–∏ –∏—Ö —Ç–µ–∫—Å—Ç –±–µ–∑ –∞–¥—Ä–µ—Å–∞. –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞–π –µ—ë.
11. –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –¢–û–õ–¨–ö–û —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ Fujida.
‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø–æ–º—è–Ω—É–ª —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥—Ä—É–≥–∏—Ö –±—Ä–µ–Ω–¥–æ–≤, –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –∏—Ö.
‚Ä¢ –í –æ—Ç–≤–µ—Ç–µ –≤–µ–∂–ª–∏–≤–æ —É—Ç–æ—á–Ω–∏, —á—Ç–æ –º—ã –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ Fujida.
‚Ä¢ –ï—Å–ª–∏ –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ –±—Ä–µ–Ω–¥–∞–º–∏ –Ω–∞–∑–≤–∞–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Fujida, –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ Fujida.
‚Ä¢ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —á—É–∂–∏–µ –º–æ–¥–µ–ª–∏.

–ü—Ä–∏–º–µ—Ä –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:
¬´Fujida Karma Pro S WiFi –∏ Fujida Karma Pro Max Duo WiFi ‚Äî —ç—Ç–æ –∫–æ–º–±–æ-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç –≤ —Å–µ–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∏–¥–µ–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, GPS-–∏–Ω—Ñ–æ—Ä–º–µ—Ä–∞ –∏ —Ä–∞–¥–∞—Ä-–¥–µ—Ç–µ–∫—Ç–æ—Ä–∞.
[–¥–∞–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–µ –æ–±—â–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ‚Üí —Ä–∞–∑–ª–∏—á–∏—è ‚Üí —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]¬ª

–ü—Ä–∏–º–µ—Ä –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–µ –ø—Ä–æ –æ–¥–Ω—É –º–æ–¥–µ–ª—å:
¬´Fujida Zoom Okko WiFi ‚Äî —ç—Ç–æ –≤–∏–¥–µ–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º –∏ –º–∞–≥–Ω–∏—Ç–Ω—ã–º –∫—Ä–µ–ø–ª–µ–Ω–∏–µ–º. –û–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ Full HD, –æ—Å–Ω–∞—â—ë–Ω —Å—É–ø–µ—Ä–∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä–æ–º –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞—Ö –æ—Ç -30 –¥–æ +70 ¬∞C –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç—ã –ø–∞–º—è—Ç–∏ microSD –¥–æ 128 –ì–ë. ‚Ä¶¬ª
"""

SPECS_SYSTEM_PROMPT = """
–¢—ã ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Fujida.
–≠—Ç–æ—Ç —Ä–µ–∂–∏–º –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, –ø–æ—ç—Ç–æ–º—É –¥–∞–π –∑–∞–≥–ª—É—à–∫—É.
–û—Ç–≤–µ—Ç—å, —á—Ç–æ –ø–æ–∏—Å–∫ –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.
"""

OTHER_SYSTEM_PROMPT = """
–¢—ã ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Fujida.
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ Fujida ‚Äî –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –æ—Ç–≤–µ—Ç.
"""

FALLBACK_SYSTEM_PROMPT = """
–¢—ã ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Fujida.
–û—Ç–≤–µ—á–∞–π –≤–µ–∂–ª–∏–≤–æ, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
"""

FALLBACK_PROMPT = """
–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

–ü—Ä–∞–≤–∏–ª–∞:
- –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ —Å–º–æ–ª—Ç–æ–∫ ‚Äî –æ—Ç–≤–µ—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.
- –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ ‚Äî –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å –º–æ–¥–µ–ª—å.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–æ–≤—Å–µ–º –Ω–µ –ø–æ —Ç–µ–º–µ ‚Äî –¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.
"""

_MD_LINK_RE = re.compile(r"\[([^\]]+)\]\((https?://[^\s)]+)\)")
_CODE_FENCE_RE = re.compile(r"```.+?```", flags=re.DOTALL)


def _markdown_links_to_html(text: str) -> str:
    def repl(m: re.Match) -> str:
        label = m.group(1).strip()
        url = m.group(2).strip()
        return f'<a href="{url}">{label}</a>'
    return _MD_LINK_RE.sub(repl, text)


def _strip_code_fences(text: str) -> str:
    return _CODE_FENCE_RE.sub("", text)


def _clean_meta_phrases(text: str) -> str:
    bad_bits = [
        "—Å—É–¥—è –ø–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
        "—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º",
        "–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ",
        "—Å–æ–≥–ª–∞—Å–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É",
        "—Å–æ–≥–ª–∞—Å–Ω–æ –¥–∞–Ω–Ω—ã–º",
        "–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö",
    ]
    out = text
    for b in bad_bits:
        out = re.sub(rf"\b{re.escape(b)}\b[:,\s]*", "", out, flags=re.IGNORECASE)
    return out


def _postprocess_answer(text: str) -> str:
    text = _strip_code_fences(text)
    text = _markdown_links_to_html(text)
    text = _clean_meta_phrases(text)
    return text.strip()


class AnswerService:
    def __init__(self, model: str = "gpt-4o") -> None:
        self._model = model

    def _build_faq_context(self, user_message: str, data: dict) -> str:
        if "exact_match" in data:
            return f"""
                –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
                "{user_message}"

                –ù–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
                Q: {data['exact_match']['question']}
                A: {data['exact_match']['answer']}
                """
        else:
            variants = "\n\n".join(
                f"{i+1}. Q: {q}\n   A: {a}"
                for i, (q, a) in enumerate(zip(data["top_questions"], data["top_answers"]))
            )
            return f"""
                –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
                "{user_message}"

                –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
                {variants}

                –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –≤—ã–±–µ—Ä–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
                –ù–µ —Å–º–µ—à–∏–≤–∞–π –æ—Ç–≤–µ—Ç—ã, –Ω–µ —Å–æ–∫—Ä–∞—â–∞–π —Ñ–∞–∫—Ç—ã, —Å–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —Å—Å—ã–ª–∫–∏.
                """

    async def generate(self, user_message: str, context: Union[str, dict, list], intent: str) -> str:
        if intent == "FAQ":
            system_prompt = FAQ_SYSTEM_PROMPT
            context_str = self._build_faq_context(user_message, context)
        elif intent == "Device":
            system_prompt = DEVICE_SYSTEM_PROMPT
            context_str = json.dumps(context, ensure_ascii=False)
        elif intent == "Specs":
            system_prompt = SPECS_SYSTEM_PROMPT
            context_str = str(context or "")
        else:
            system_prompt = OTHER_SYSTEM_PROMPT
            context_str = str(context or "")

        prompt = f"""
            {context_str}
            """.strip()

        inputs = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": prompt},
        ]

        logger.info("AnswerService.generate inputs=%s", json.dumps(inputs, ensure_ascii=False))
        logger.info("AnswerService.generate system_prompt_len=%d user_prompt_len=%d",
                     len(system_prompt), len(prompt))

        client = await ensure_openai_client()
        if intent == "FAQ":
            resp = await client.responses.create(
                model=self._model,
                input=inputs,
                temperature=0.6,
            )
        else:
            resp = await client.responses.create(
                model=self._model,
                input=inputs,
            )
        raw = resp.output_text.strip()
        return _postprocess_answer(raw)

    async def fallback(self, user_message: str) -> str:
        prompt = FALLBACK_PROMPT.format(user_message=user_message)
        inputs = [
            {"role": "system", "content": FALLBACK_SYSTEM_PROMPT},
            {"role": "user", "content": prompt},
        ]

        logger.info("AnswerService.fallback inputs=%s", json.dumps(inputs, ensure_ascii=False))
        logger.info("AnswerService.fallback system_prompt_len=%d user_prompt_len=%d",
                     len(FALLBACK_SYSTEM_PROMPT), len(prompt))

        client = await ensure_openai_client()
        resp = await client.responses.create(
            model=self._model,
            input=inputs,
        )
        raw = resp.output_text.strip()
        return _postprocess_answer(raw)